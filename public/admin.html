<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ride Admin</title>
  <link rel="stylesheet" href="/css/global.css" />
  <link rel="stylesheet" href="/css/app.css" />
  <style>
    body { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    h1 { margin-bottom: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; }
    th { color: var(--text-secondary); font-weight: 600; }
    tbody tr:hover { background: rgba(255,255,255,0.03); }
    .badge { padding: 2px 8px; border-radius: 999px; background: var(--bg-tertiary); font-size: 12px; }
    .muted { color: var(--text-secondary); }
  </style>
</head>
<body>
  <h1>Ride Admin</h1>
  <p class="muted">Zero Trust should sit in front of this page. Lists users across providers.</p>
  <div id="status" class="muted">Loading...</div>
  <table id="usersTable" class="hidden">
    <thead>
      <tr>
        <th>Email</th>
        <th>Name</th>
        <th>Provider</th>
        <th>Provider ID</th>
        <th>Created</th>
        <th>Last Login</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2 style="margin-top:32px">Recent Logins</h2>
  <p class="muted">Lightweight audit (last 100 events).</p>
  <table id="loginsTable" class="hidden">
    <thead>
      <tr>
        <th>Email</th>
        <th>Provider</th>
        <th>IP</th>
        <th>User Agent</th>
        <th>When</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function loadUsers() {
      const status = document.getElementById('status');
      const table = document.getElementById('usersTable');
      try {
        const res = await fetch('/api/admin/users', { credentials: 'include' });
        if (!res.ok) throw new Error('Request failed');
        const data = await res.json();
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        (data.users || []).forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.email || ''}</td>
            <td>${u.name || ''}</td>
            <td><span class="badge">${u.provider || ''}</span></td>
            <td class="muted">${u.provider_id || ''}</td>
            <td class="muted">${u.created_at || ''}</td>
            <td class="muted">${u.last_login || u.updated_at || ''}</td>
          `;
          tbody.appendChild(tr);
        });
        status.textContent = `Loaded ${data.users?.length || 0} users`;
        table.classList.remove('hidden');
      } catch (err) {
        status.textContent = 'Failed to load users';
        console.error(err);
      }
    }

    async function loadLogins() {
      const table = document.getElementById('loginsTable');
      try {
        const res = await fetch('/api/admin/logins', { credentials: 'include' });
        if (!res.ok) throw new Error('Request failed');
        const data = await res.json();
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        (data.events || []).forEach(e => {
          const tr = document.createElement('tr');
          const ua = (e.user_agent || '').slice(0, 120);
          tr.innerHTML = `
            <td>${e.email || ''}</td>
            <td><span class="badge">${e.provider || ''}</span></td>
            <td class="muted">${e.ip || ''}</td>
            <td class="muted" title="${e.user_agent || ''}">${ua}</td>
            <td class="muted">${e.created_at || ''}</td>
          `;
          tbody.appendChild(tr);
        });
        table.classList.remove('hidden');
      } catch (err) {
        console.error(err);
      }
    }

    loadUsers();
    loadLogins();
  </script>
</body>
</html>
