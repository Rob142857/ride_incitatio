<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ride — Admin</title>
  <link rel="stylesheet" href="/css/global.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { max-width: 1280px; margin: 0 auto; padding: 28px 20px 60px; font-family: var(--font-sans); color: var(--neutral-900); background: var(--neutral-50); }

    /* Header */
    .dash-header { display: flex; align-items: baseline; gap: 12px; margin-bottom: 6px; }
    .dash-header h1 { font-size: 1.35rem; font-weight: 700; margin: 0; letter-spacing: -0.01em; }
    .dash-header .env-badge { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; padding: 2px 8px; border-radius: 999px; background: #dcfce7; color: #166534; }
    .dash-sub { color: var(--neutral-500); font-size: 0.82rem; margin: 0 0 24px; }

    /* Stat cards */
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-bottom: 28px; }
    .stat-card { background: var(--white); border: 1px solid var(--neutral-200); border-radius: 10px; padding: 16px 18px; }
    .stat-card .label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--neutral-500); margin-bottom: 4px; }
    .stat-card .value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
    .stat-card .detail { font-size: 0.75rem; color: var(--neutral-500); margin-top: 2px; }

    /* Activity chart */
    .chart-wrap { background: var(--white); border: 1px solid var(--neutral-200); border-radius: 10px; padding: 18px 20px; margin-bottom: 28px; }
    .chart-wrap h2 { font-size: 0.85rem; font-weight: 600; margin: 0 0 12px; }
    .chart-bar-row { display: flex; align-items: flex-end; gap: 3px; height: 80px; }
    .chart-bar { flex: 1; min-width: 6px; background: var(--accent); border-radius: 3px 3px 0 0; transition: height 0.3s ease; position: relative; cursor: default; }
    .chart-bar:hover { opacity: 0.8; }
    .chart-bar .tip { display: none; position: absolute; bottom: calc(100% + 4px); left: 50%; transform: translateX(-50%); background: var(--neutral-900); color: var(--white); font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; white-space: nowrap; z-index: 2; }
    .chart-bar:hover .tip { display: block; }
    .chart-labels { display: flex; gap: 3px; margin-top: 4px; }
    .chart-labels span { flex: 1; text-align: center; font-size: 0.6rem; color: var(--neutral-400); }

    /* Sections */
    .section { margin-bottom: 32px; }
    .hidden { display: none !important; }

    /* Toolbar */
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
    .toolbar button { padding: 5px 12px; border: 1px solid var(--neutral-200); border-radius: 6px; background: var(--white); cursor: pointer; font-size: 0.78rem; font-weight: 500; transition: all 0.15s ease; }
    .toolbar button:hover { background: var(--neutral-100); border-color: var(--neutral-300); }
    .toolbar button.primary { background: var(--accent); color: var(--white); border-color: var(--accent); }
    .toolbar button.primary:hover { opacity: 0.85; }
    .toolbar .spacer { flex: 1; }
    .toolbar .count { font-size: 0.78rem; color: var(--neutral-500); }
    .toolbar input[type="search"] { padding: 5px 10px; border: 1px solid var(--neutral-200); border-radius: 6px; font-size: 0.78rem; width: 180px; outline: none; }
    .toolbar input[type="search"]:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,0.15); }

    /* Table */
    .table-wrap { overflow-x: auto; border: 1px solid var(--neutral-200); border-radius: 10px; background: var(--white); }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    th, td { padding: 9px 12px; text-align: left; white-space: nowrap; }
    th { color: var(--neutral-500); font-weight: 600; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.04em; background: var(--neutral-50); border-bottom: 1px solid var(--neutral-200); position: sticky; top: 0; z-index: 1; }
    td { border-bottom: 1px solid var(--neutral-100); }
    tbody tr { transition: background 0.12s ease; }
    tbody tr:hover { background: var(--neutral-50); }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr.selected { background: rgba(59, 130, 246, 0.06); }

    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.7rem; font-weight: 500; }
    .badge-google { background: #fef3c7; color: #92400e; }
    .badge-microsoft { background: #dbeafe; color: #1e40af; }
    .badge-default { background: var(--neutral-200); color: var(--neutral-700); }
    .muted { color: var(--neutral-500); }
    td.email-cell { font-weight: 500; }
    input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }

    .avatar { width: 22px; height: 22px; border-radius: 50%; vertical-align: middle; margin-right: 6px; background: var(--neutral-200); }
    .avatar-initial { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; border-radius: 50%; font-size: 0.65rem; font-weight: 600; color: #fff; vertical-align: middle; margin-right: 6px; }
    .mono { font-family: var(--font-mono); font-size: 0.75rem; }

    /* Tabs */
    .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--neutral-200); margin-bottom: 16px; }
    .tab { padding: 8px 16px; font-size: 0.82rem; font-weight: 500; color: var(--neutral-500); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s ease; user-select: none; }
    .tab:hover { color: var(--neutral-900); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* Responsive */
    @media (max-width: 640px) {
      .stat-grid { grid-template-columns: repeat(2, 1fr); }
      .toolbar input[type="search"] { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="dash-header">
    <h1>Ride Admin</h1>
    <span class="env-badge">Production</span>
  </div>
  <p class="dash-sub">Dashboard &middot; ride.incitat.io &middot; Protected by Cloudflare Zero Trust</p>

  <!-- Stats -->
  <div class="stat-grid" id="statsGrid">
    <div class="stat-card"><div class="label">Users</div><div class="value" id="statUsers">&mdash;</div><div class="detail" id="statUsersDetail"></div></div>
    <div class="stat-card"><div class="label">Trips</div><div class="value" id="statTrips">&mdash;</div></div>
    <div class="stat-card"><div class="label">Waypoints</div><div class="value" id="statWaypoints">&mdash;</div></div>
    <div class="stat-card"><div class="label">Journal Notes</div><div class="value" id="statJournals">&mdash;</div></div>
    <div class="stat-card"><div class="label">Attachments</div><div class="value" id="statAttachments">&mdash;</div><div class="detail" id="statStorage"></div></div>
    <div class="stat-card"><div class="label">Logins (7d)</div><div class="value" id="statLogins7d">&mdash;</div><div class="detail" id="statLogins30d"></div></div>
  </div>

  <!-- Activity chart -->
  <div class="chart-wrap" id="chartWrap">
    <h2>Login Activity &mdash; Last 30 Days</h2>
    <div class="chart-bar-row" id="chartBars"></div>
    <div class="chart-labels" id="chartLabels"></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="users" onclick="switchTab('users')">Users</div>
    <div class="tab" data-tab="logins" onclick="switchTab('logins')">Audit Log</div>
  </div>

  <!-- Users tab -->
  <div class="section" id="tabUsers">
    <div class="toolbar">
      <input type="search" id="userSearch" placeholder="Filter by email or name&hellip;" oninput="filterUsers()" />
      <span class="spacer"></span>
      <span class="count" id="selCount">0 selected</span>
      <button onclick="composeEmail()">&#9993; Email Selected</button>
      <button class="primary" onclick="composeEmailAll()">&#9993; Email All</button>
    </div>
    <div class="table-wrap">
      <table id="usersTable">
        <thead>
          <tr>
            <th style="width:30px"><input type="checkbox" id="checkAll" onchange="toggleSelectAll(this.checked)" /></th>
            <th>User</th>
            <th>Email</th>
            <th>Provider</th>
            <th>Trips</th>
            <th>Identities</th>
            <th>Created</th>
            <th>Last Login</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Audit Log tab -->
  <div class="section hidden" id="tabLogins">
    <div class="toolbar">
      <input type="search" id="loginSearch" placeholder="Filter by email, IP, country&hellip;" oninput="filterLogins()" />
      <span class="spacer"></span>
      <span class="count" id="loginCount"></span>
    </div>
    <div class="table-wrap">
      <table id="loginsTable">
        <thead>
          <tr>
            <th>Time</th>
            <th>Email</th>
            <th>Provider</th>
            <th>IP Address</th>
            <th>Country</th>
            <th>Platform</th>
            <th>User Agent</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const SUPPORT_EMAIL = 'desk@incitat.io';
    let allUsers = [];
    let allLogins = [];

    /* ── Helpers ──────────────────────────────────────────── */

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s ?? '';
      return d.innerHTML;
    }

    function fmtNum(n) {
      return (n ?? 0).toLocaleString();
    }

    function fmtBytes(b) {
      if (!b || b < 1024) return (b ?? 0) + ' B';
      if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
      if (b < 1073741824) return (b / 1048576).toFixed(1) + ' MB';
      return (b / 1073741824).toFixed(2) + ' GB';
    }

    function fmtDate(iso) {
      if (!iso) return '\u2014';
      const d = new Date(iso + (iso.endsWith('Z') ? '' : 'Z'));
      return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function fmtRelative(iso) {
      if (!iso) return '\u2014';
      const d = new Date(iso + (iso.endsWith('Z') ? '' : 'Z'));
      const diff = Date.now() - d.getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + 'm ago';
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      const days = Math.floor(hrs / 24);
      if (days < 7) return days + 'd ago';
      return fmtDate(iso);
    }

    function providerBadge(p) {
      var cls = p === 'google' ? 'badge-google' : p === 'microsoft' ? 'badge-microsoft' : 'badge-default';
      return '<span class="badge ' + cls + '">' + esc(p) + '</span>';
    }

    var PALETTE = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316'];
    function initialColor(name) {
      var h = 0;
      for (var i = 0; i < (name||'').length; i++) h = ((h << 5) - h) + name.charCodeAt(i);
      return PALETTE[Math.abs(h) % PALETTE.length];
    }

    function avatarHtml(u) {
      if (u.avatar_url) return '<img class="avatar" src="' + esc(u.avatar_url) + '" alt="" loading="lazy">';
      var init = (u.name || u.email || '?').charAt(0).toUpperCase();
      return '<span class="avatar-initial" style="background:' + initialColor(u.name||u.email) + '">' + init + '</span>';
    }

    /* ── Tabs ─────────────────────────────────────────────── */

    function switchTab(name) {
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.toggle('active', t.dataset.tab === name); });
      document.getElementById('tabUsers').classList.toggle('hidden', name !== 'users');
      document.getElementById('tabLogins').classList.toggle('hidden', name !== 'logins');
    }

    /* ── Stats ────────────────────────────────────────────── */

    async function loadStats() {
      try {
        var res = await fetch('/api/admin/stats');
        if (!res.ok) return;
        var s = await res.json();
        document.getElementById('statUsers').textContent = fmtNum(s.users);
        document.getElementById('statUsersDetail').textContent = '+' + s.signups7d + ' this week';
        document.getElementById('statTrips').textContent = fmtNum(s.trips);
        document.getElementById('statWaypoints').textContent = fmtNum(s.waypoints);
        document.getElementById('statJournals').textContent = fmtNum(s.journals);
        document.getElementById('statAttachments').textContent = fmtNum(s.attachments);
        document.getElementById('statStorage').textContent = fmtBytes(s.storageBytes);
        document.getElementById('statLogins7d').textContent = fmtNum(s.logins7d);
        document.getElementById('statLogins30d').textContent = fmtNum(s.logins30d) + ' in 30d';
        renderChart(s.loginsByDay || []);
      } catch (err) {
        console.error('Stats load error:', err);
      }
    }

    function renderChart(data) {
      var bars = document.getElementById('chartBars');
      var labels = document.getElementById('chartLabels');
      if (!data.length) { bars.innerHTML = '<span class="muted" style="margin:auto;font-size:0.8rem">No login data yet</span>'; return; }

      // Fill gaps in the 30-day range
      var dayMap = new Map(data.map(function(d) { return [d.day, d.count]; }));
      var filled = [];
      var now = new Date();
      for (var i = 29; i >= 0; i--) {
        var dt = new Date(now); dt.setDate(dt.getDate() - i);
        var key = dt.toISOString().slice(0, 10);
        filled.push({ day: key, count: dayMap.get(key) || 0 });
      }

      var max = Math.max.apply(null, filled.map(function(d) { return d.count; }).concat([1]));
      bars.innerHTML = filled.map(function(d) {
        var h = Math.max(2, (d.count / max) * 100);
        var dayLabel = new Date(d.day).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        return '<div class="chart-bar" style="height:' + h + '%"><div class="tip">' + dayLabel + ': ' + d.count + '</div></div>';
      }).join('');

      // Show every 5th label
      labels.innerHTML = filled.map(function(d, idx) {
        var show = idx % 5 === 0 || idx === filled.length - 1;
        return '<span>' + (show ? new Date(d.day).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '') + '</span>';
      }).join('');
    }

    /* ── Users ────────────────────────────────────────────── */

    async function loadUsers() {
      try {
        var res = await fetch('/api/admin/users');
        if (!res.ok) throw new Error('Request failed');
        var data = await res.json();
        allUsers = data.users || [];
        renderUsers(allUsers);
      } catch (err) {
        console.error('Users load error:', err);
      }
    }

    function renderUsers(list) {
      var tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      list.forEach(function(u) {
        var origIdx = allUsers.indexOf(u);
        var tr = document.createElement('tr');
        tr.dataset.index = origIdx;
        tr.innerHTML =
          '<td><input type="checkbox" class="user-check" data-index="' + origIdx + '" onchange="updateSelection()" /></td>' +
          '<td>' + avatarHtml(u) + esc(u.name || '\u2014') + '</td>' +
          '<td class="email-cell">' + esc(u.email) + '</td>' +
          '<td>' + providerBadge(u.provider) + '</td>' +
          '<td>' + (u.trip_count ?? 0) + '</td>' +
          '<td>' + (u.identity_count ?? 1) + '</td>' +
          '<td class="muted" title="' + esc(u.created_at) + '">' + fmtDate(u.created_at) + '</td>' +
          '<td class="muted" title="' + esc(u.last_login || u.updated_at) + '">' + fmtRelative(u.last_login || u.updated_at) + '</td>';
        tbody.appendChild(tr);
      });
    }

    function filterUsers() {
      var q = document.getElementById('userSearch').value.toLowerCase().trim();
      if (!q) { renderUsers(allUsers); return; }
      renderUsers(allUsers.filter(function(u) {
        return (u.email||'').toLowerCase().includes(q) || (u.name||'').toLowerCase().includes(q);
      }));
    }

    /* ── Audit Log ────────────────────────────────────────── */

    async function loadLogins() {
      try {
        var res = await fetch('/api/admin/logins');
        if (!res.ok) return;
        var data = await res.json();
        allLogins = data.events || [];
        renderLogins(allLogins);
        document.getElementById('loginCount').textContent = allLogins.length + ' events';
      } catch (err) {
        console.error('Logins load error:', err);
      }
    }

    function renderLogins(list) {
      var tbody = document.querySelector('#loginsTable tbody');
      tbody.innerHTML = '';
      list.forEach(function(e) {
        var country = '', platform = '';
        try {
          var h = JSON.parse(e.client_hints || '{}');
          country = h.cfCountry || '';
          platform = (h.uaPlatform || '').replace(/"/g, '');
        } catch(_) {}
        var ua = e.user_agent || '';
        var uaShort = ua.length > 80 ? ua.slice(0, 80) + '\u2026' : ua;
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td class="muted" title="' + esc(e.created_at) + '">' + fmtRelative(e.created_at) + '</td>' +
          '<td class="email-cell">' + esc(e.email) + '</td>' +
          '<td>' + providerBadge(e.provider) + '</td>' +
          '<td class="mono">' + esc(e.ip) + '</td>' +
          '<td>' + (country ? esc(country) : '<span class="muted">\u2014</span>') + '</td>' +
          '<td>' + (platform ? esc(platform) : '<span class="muted">\u2014</span>') + '</td>' +
          '<td class="muted" title="' + esc(ua) + '">' + esc(uaShort) + '</td>';
        tbody.appendChild(tr);
      });
    }

    function filterLogins() {
      var q = document.getElementById('loginSearch').value.toLowerCase().trim();
      if (!q) { renderLogins(allLogins); return; }
      renderLogins(allLogins.filter(function(e) {
        var hints = '';
        try { var h = JSON.parse(e.client_hints || '{}'); hints = (h.cfCountry||'') + ' ' + (h.uaPlatform||''); } catch(_) {}
        return [e.email, e.ip, e.provider, hints, e.user_agent].join(' ').toLowerCase().includes(q);
      }));
    }

    /* ── Selection / Email ────────────────────────────────── */

    function getChecked() {
      return Array.from(document.querySelectorAll('.user-check:checked')).map(function(cb) { return Number(cb.dataset.index); });
    }

    function updateSelection() {
      var indices = getChecked();
      document.getElementById('selCount').textContent = indices.length + ' selected';
      document.querySelectorAll('#usersTable tbody tr').forEach(function(tr) {
        var cb = tr.querySelector('.user-check');
        tr.classList.toggle('selected', cb ? cb.checked : false);
      });
      var total = document.querySelectorAll('.user-check').length;
      document.getElementById('checkAll').checked = indices.length === total && total > 0;
    }

    function toggleSelectAll(checked) {
      document.querySelectorAll('.user-check').forEach(function(cb) { cb.checked = !!checked; });
      document.getElementById('checkAll').checked = !!checked;
      updateSelection();
    }

    function composeEmail() {
      var indices = getChecked();
      if (!indices.length) { alert('Select at least one user.'); return; }
      openMailto(indices.map(function(i) { return allUsers[i] ? allUsers[i].email : null; }).filter(Boolean));
    }

    function composeEmailAll() {
      var emails = allUsers.map(function(u) { return u.email; }).filter(Boolean);
      if (!emails.length) { alert('No users loaded.'); return; }
      openMailto(emails);
    }

    function openMailto(bccList) {
      window.location.href = 'mailto:' + SUPPORT_EMAIL + '?bcc=' + encodeURIComponent(bccList.join(',')) + '&subject=' + encodeURIComponent('Ride \u2014 ');
    }

    /* ── Init ─────────────────────────────────────────────── */

    loadStats();
    loadUsers();
    loadLogins();
  </script>
</body>
</html>
