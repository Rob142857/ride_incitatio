<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ride Admin</title>
  <link rel="stylesheet" href="/css/global.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { max-width: 1200px; margin: 0 auto; padding: 32px 20px; font-family: var(--font-sans); color: var(--neutral-900); background: var(--neutral-50); }
    h1 { font-size: 1.5rem; font-weight: 700; margin: 0 0 4px; }
    h2 { font-size: 1.1rem; font-weight: 600; margin: 32px 0 4px; }
    .subtitle { color: var(--neutral-500); font-size: 0.85rem; margin: 0 0 16px; }
    .hidden { display: none !important; }

    /* Toolbar */
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
    .toolbar button { padding: 6px 14px; border: 1px solid var(--border); border-radius: var(--radius-btn); background: var(--white); cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: background var(--transition-fast); }
    .toolbar button:hover { background: var(--neutral-100); }
    .toolbar button.primary { background: var(--accent); color: var(--white); border-color: var(--accent); }
    .toolbar button.primary:hover { opacity: 0.85; }
    .toolbar .spacer { flex: 1; }
    .toolbar .count { font-size: 0.8rem; color: var(--neutral-500); }

    /* Table */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--neutral-200); text-align: left; white-space: nowrap; }
    th { color: var(--neutral-500); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; position: sticky; top: 0; background: var(--neutral-50); }
    tbody tr { transition: background var(--transition-fast); }
    tbody tr:hover { background: var(--neutral-100); }
    tbody tr.selected { background: rgba(17, 24, 39, 0.06); }
    .badge { display: inline-block; padding: 2px 8px; border-radius: var(--radius-btn); background: var(--neutral-200); font-size: 0.75rem; font-weight: 500; }
    .muted { color: var(--neutral-500); }
    td.email-cell { font-weight: 500; }
    input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }
  </style>
</head>
<body>
  <h1>Ride Admin</h1>
  <p class="subtitle">User management and audit log &middot; desk@incitat.io</p>
  <div id="status" style="color:var(--neutral-500);font-size:0.85rem;margin-bottom:12px"></div>

  <!-- Users section -->
  <div id="usersSection">
    <h2>Users</h2>
    <div class="toolbar">
      <button onclick="toggleSelectAll()">Select All</button>
      <button onclick="deselectAll()">Deselect</button>
      <span class="spacer"></span>
      <span class="count" id="selCount">0 selected</span>
      <button class="primary" onclick="composeEmail()">✉ Email Selected</button>
      <button class="primary" onclick="composeEmailAll()">✉ Email All</button>
    </div>
    <div class="table-wrap">
      <table id="usersTable">
        <thead>
          <tr>
            <th style="width:30px"><input type="checkbox" id="checkAll" onchange="toggleSelectAll(this.checked)" /></th>
            <th>Email</th>
            <th>Name</th>
            <th>Provider</th>
            <th>Created</th>
            <th>Last Login</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Recent logins -->
    <h2>Recent Logins</h2>
    <p class="subtitle">Last 100 login events — lightweight audit trail.</p>
    <div class="table-wrap">
      <table id="loginsTable">
        <thead>
          <tr>
            <th>Email</th>
            <th>Provider</th>
            <th>IP</th>
            <th>Country</th>
            <th>User Agent</th>
            <th>When</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const SUPPORT_EMAIL = 'desk@incitat.io';
    let allUsers = [];

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    // Auto-load on page ready (protected by Cloudflare Zero Trust)
    document.getElementById('status').textContent = 'Loading…';
    loadUsers();
    loadLogins();

    async function loadUsers() {
      const status = document.getElementById('status');
      try {
        const res = await fetch('/api/admin/users');
        if (!res.ok) throw new Error('Request failed');
        const data = await res.json();
        allUsers = data.users || [];

        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = '';
        allUsers.forEach((u, i) => {
          const tr = document.createElement('tr');
          tr.dataset.index = i;
          tr.innerHTML = `
            <td><input type="checkbox" class="user-check" data-index="${i}" onchange="updateSelection()" /></td>
            <td class="email-cell">${esc(u.email)}</td>
            <td>${esc(u.name)}</td>
            <td><span class="badge">${esc(u.provider)}</span></td>
            <td class="muted">${esc(u.created_at?.slice(0, 10))}</td>
            <td class="muted">${esc(u.last_login?.slice(0, 16) || u.updated_at?.slice(0, 16) || '—')}</td>
          `;
          tbody.appendChild(tr);
        });

        status.textContent = `${allUsers.length} user${allUsers.length === 1 ? '' : 's'}`;
      } catch (err) {
        status.textContent = 'Failed to load users.';
        console.error(err);
      }
    }

    async function loadLogins() {
      try {
        const res = await fetch('/api/admin/logins');
        if (!res.ok) return;
        const data = await res.json();
        const tbody = document.querySelector('#loginsTable tbody');
        tbody.innerHTML = '';
        (data.events || []).forEach(e => {
          let country = '';
          try { const h = JSON.parse(e.client_hints || '{}'); country = h.cfCountry || ''; } catch(_) {}
          const ua = (e.user_agent || '').slice(0, 100);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="email-cell">${esc(e.email)}</td>
            <td><span class="badge">${esc(e.provider)}</span></td>
            <td class="muted">${esc(e.ip)}</td>
            <td class="muted">${esc(country)}</td>
            <td class="muted" title="${esc(e.user_agent)}">${esc(ua)}</td>
            <td class="muted">${esc(e.created_at?.slice(0, 16))}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
      }
    }

    /* Selection helpers */
    function getChecked() {
      return [...document.querySelectorAll('.user-check:checked')].map(cb => Number(cb.dataset.index));
    }

    function updateSelection() {
      const indices = getChecked();
      document.getElementById('selCount').textContent = `${indices.length} selected`;
      document.querySelectorAll('#usersTable tbody tr').forEach(tr => {
        const cb = tr.querySelector('.user-check');
        tr.classList.toggle('selected', cb?.checked);
      });
      document.getElementById('checkAll').checked = indices.length === allUsers.length && allUsers.length > 0;
    }

    function toggleSelectAll(checked) {
      const state = checked !== undefined ? checked : !document.getElementById('checkAll').checked;
      document.querySelectorAll('.user-check').forEach(cb => cb.checked = state);
      document.getElementById('checkAll').checked = state;
      updateSelection();
    }

    function deselectAll() {
      document.querySelectorAll('.user-check').forEach(cb => cb.checked = false);
      document.getElementById('checkAll').checked = false;
      updateSelection();
    }

    /* Mailto helpers */
    function composeEmail() {
      const indices = getChecked();
      if (!indices.length) { alert('Select at least one user.'); return; }
      const emails = indices.map(i => allUsers[i].email).filter(Boolean);
      openMailto(emails);
    }

    function composeEmailAll() {
      const emails = allUsers.map(u => u.email).filter(Boolean);
      if (!emails.length) { alert('No users loaded.'); return; }
      openMailto(emails);
    }

    function openMailto(bccList) {
      // desk@incitat.io as visible recipient, users in BCC for privacy
      const bcc = bccList.join(',');
      const subject = encodeURIComponent('Ride — ');
      window.location.href = `mailto:${SUPPORT_EMAIL}?bcc=${encodeURIComponent(bcc)}&subject=${subject}`;
    }
  </script>
</body>
</html>
